<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç§æœ‰äº‘ç›˜</title>
    <script src="config.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .container { width: 90%; max-width: 400px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; color: white; transition: 0.2s; }
        .btn-primary { background: #007aff; }
        .btn-primary:hover { background: #005bb5; }
        .btn-danger { background: #ff3b30; margin-top: 10px; }
        
        .toggle-link { text-align: center; margin-top: 15px; color: #666; font-size: 14px; cursor: pointer; text-decoration: underline; }
        
        .hidden { display: none; }
        
        /* æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .file-list { margin-top: 20px; border-top: 1px solid #eee; }
        .file-item { padding: 12px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .file-item a { color: #007aff; text-decoration: none; }
    </style>
</head>
<body>

    <div class="container" id="auth-box">
        <h2 id="title">ç™»å½•äº‘ç›˜</h2>
        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
        
        <button class="btn btn-primary" onclick="handleAuth()" id="btn-submit">ç™»å½•</button>
        
        <div class="toggle-link" onclick="toggleMode()" id="toggle-text">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</div>
    </div>

    <div class="container hidden" id="main-box">
        <h2>ğŸ“ æ–‡ä»¶åˆ—è¡¨</h2>
        
        <div style="background: #f9f9f9; border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
            ğŸ“¤ ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶
            <input type="file" id="fileInput" multiple style="display:none" onchange="uploadFiles(this.files)">
        </div>
        <p id="status" style="text-align: center; color: green; height: 20px;"></p>

        <div class="file-list" id="file-list"></div>

        <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <script>
        let isLogin = true; // å½“å‰æ˜¯ç™»å½•æ¨¡å¼è¿˜æ˜¯æ³¨å†Œæ¨¡å¼

        // 1. è¿›é¡µé¢å…ˆæ£€æŸ¥æœ‰æ²¡æœ‰ Token
        if (localStorage.getItem('token')) {
            showMain();
        }

        // åˆ‡æ¢ ç™»å½•/æ³¨å†Œ æ¨¡å¼
        function toggleMode() {
            isLogin = !isLogin;
            document.getElementById('title').innerText = isLogin ? "ç™»å½•äº‘ç›˜" : "æ³¨å†Œæ–°è´¦å·";
            document.getElementById('btn-submit').innerText = isLogin ? "ç™»å½•" : "æ³¨å†Œ";
            document.getElementById('toggle-text').innerText = isLogin ? "æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ" : "å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•";
        }

        // å¤„ç†ç‚¹å‡»æŒ‰é’®
        async function handleAuth() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return alert("è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º");

            const url = isLogin ? `${API_BASE_URL}/api/login` : `${API_BASE_URL}/api/register`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                const data = await res.json();

                if (data.success) {
                    if (isLogin) {
                        // ç™»å½•æˆåŠŸï¼ŒæŠŠä»¤ç‰Œå­˜èµ·æ¥ï¼
                        localStorage.setItem('token', data.token);
                        showMain();
                    } else {
                        alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                        toggleMode(); // åˆ‡å›ç™»å½•ç•Œé¢
                    }
                } else {
                    alert("é”™è¯¯: " + data.msg);
                }
            } catch (e) {
                alert("æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ config.js é‡Œçš„åœ°å€å¯¹ä¸å¯¹ï¼\n" + e);
            }
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMain() {
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('main-box').classList.remove('hidden');
            loadFiles();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/files`, {
                    headers: { 'Authorization': localStorage.getItem('token') } // å¸¦ä¸Šä»¤ç‰Œ
                });
                if(res.status === 401) { alert("ç™»å½•è¿‡æœŸ"); logout(); return; }
                
                const data = await res.json();
                const list = document.getElementById('file-list');
                list.innerHTML = '';
                data.files.forEach(f => {
                    list.innerHTML += `
                        <div class="file-item">
                            <span>${f.name} <small style="color:#888">(${f.size})</small></span>
                            <a href="${API_BASE_URL}/api/download/${f.name}?token=${localStorage.getItem('token')}">ä¸‹è½½</a>
                        </div>`;
                });
            } catch(e) { console.error(e); }
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFiles(files) {
            if(!files.length) return;
            const fd = new FormData();
            for(let f of files) fd.append('file', f);
            
            document.getElementById('status').innerText = "æ­£åœ¨ä¸Šä¼ ...";
            try {
                const res = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': localStorage.getItem('token') }, // å¸¦ä¸Šä»¤ç‰Œ
                    body: fd
                });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('status').innerText = "âœ… ä¸Šä¼ æˆåŠŸ";
                    loadFiles();
                } else {
                    alert("ä¸Šä¼ å¤±è´¥");
                }
            } catch(e) { alert("ä¸Šä¼ å‡ºé”™"); }
        }
    </script>
</body>
</html>